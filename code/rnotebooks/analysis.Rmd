---
title: "Sub-pupulation Analysis and Modeling"
output: html_notebook
---
This Sythetic data was created using the Synthea<sup>TM</sup> Sythetic Patient Population Simulator.  This simulator generates realistic (but not real) patient data which is ideal for the study of analytics.

The simulator generates 10 different CSV files which contain a wide variety of health conditions, treatments, and outcomes for different geographic regions. You can read about the metadata generated by the simulator [here](https://github.com/synthetichealth/synthea/wiki/CSV-File-Data-Dictionary). The simulated population can be of any size and can be followed for as many years as desired.

In this example, we have generated approximately 10,000 records for individual populations in NY and MA.  Each of the files are in the ma and ny folders.

Our subpopulation analysis will examine individuals with specific conditions.  To start, let's begin by exploring the conditions.csv folders for each state.

```{r}
#This loads the tidyverse library, which we will be using later.
library(tidyverse)

#Sets the working directory to our main base directory.
setwd("~/data/INCITE/Health_INCITE/synthea/ny_ma_10K")

conditions_ny <-read_csv("./ny/csv/conditions.csv")
```

### Understanding Dataframe Structure
Here we can see that there are 6 different fields in the conditions dataframe that we imported.  Detailed descriptions of each can be found [here](https://github.com/synthetichealth/synthea/wiki/CSV-File-Data-Dictionary#conditions).

It is also worthwhile to double click on the dataframe and look at it in the RSTUDIO embedded browser.

Your can see that individuals can be diagnosed with conditions and that these conditions can apply during a specific time period.  Further, we can see that the conditions field has both a code and a description.

Nearly everything that can happen to a patient has a code, and there are a number of different ontologies that can be used to track conditions.

This simulator uses [SNOMED-CT codes]


```{r}
conditions_sum_ny <-conditions_ny %>%
  count(CODE, DESCRIPTION) %>%
  mutate(prop = prop.table(n)) %>%
  arrange(desc(n))
```

## YOU SHOULD FIND THAT MOST PEOPLE IN NY GO TO THE DR FOR 'Viral sinusitis (disorder)' WHICH SOUNDS TO ME LIKE A RUNNY NOSE.

## TAKE SOME TIME AND COMPARE THE TOP 5 CONDITIONS IN BOTH NY AND MA. ANY DIFFERENCES?

## Investigating Diabetes

Let's further filter our data by only those conditions which relate to diabetes.

```{r}
conditions_sum_ny_diabetes <- conditions_sum_ny %>%
  filter(str_detect(DESCRIPTION, 'Diabetes|diabetes') )
```

## Diabetes and Disease Progression
We can see that of our origional population there is a progression of the disease from prediabetes, to diabetes, and further to a number of additional negative consequences of the disease from "Neuropathy due to type 2 diabetes mellitus" to "Diabetic retinopathy associated with type II diabetes mellitus."

You can read more about the progression of type II diabetes [here](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2811457/).

### Selecting Individuals with Diabetes Related Conditions

We next want to explicitly select the population of individuals who have some type of diabetes related disorder and those that do not.

```{r}
#Select out those codes associated with diabetes.
#These codes are consistent for NY and MA
d_codes<-conditions_sum_ny_diabetes$CODE
#Filter the conditions to only include those patients with diabetes related codes
conditions_ny_diabetes <- conditions_ny %>%
  filter(CODE %in% d_codes)
```

### Joining Patient Data
The organization of the data provided is similar to what you would find in most datasets.

```{r}
patients_ny <-read_csv("./ny/csv/patients.csv")
encounters_ny <-read_csv("./ny/csv/encounters.csv")

c_e_p_ny<-conditions_ny_diabetes %>% inner_join(encounters_ny, by = c("ENCOUNTER" = "ID")) %>%
inner_join(patients_ny, by = c("PATIENT.x" = "ID"))


```
